name: Reusable Docker CI Pipeline

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      jar_path:
        required: true
        type: string
      build_command:
        required: true
        type: string
      dockerfile_path:
        required: false
        default: Dockerfile
        type: string

      # -------- Sonar inputs --------
      sonar_project_key:
        required: false
        type: string
      sonar_host_url:
        required: false
        type: string
      sonar_organization:
        required: false
        type: string
      sonar_token:
        required: false
        type: string

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Run tests & calculate coverage
        id: local_coverage
        run: |
          ./mvnw clean test jacoco:report

          XML="target/site/jacoco/jacoco.xml"
          if [ ! -f "$XML" ]; then
            echo "JaCoCo report not found!"
            exit 1
          fi

          COVERED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'covered="\K[0-9]+' | awk '{s+=$1} END {print s}')
          MISSED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'missed="\K[0-9]+' | awk '{s+=$1} END {print s}')

          TOTAL=$((COVERED + MISSED))
          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED/$TOTAL)*100}")

          echo "Local Code Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

      - name: Publish local coverage to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Local Code Coverage:** ${{ steps.local_coverage.outputs.coverage }}%`
            })

      - name: SonarCloud Scan
        if: inputs.sonar_token != ''
        env:
          SONAR_TOKEN: ${{ inputs.sonar_token }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=${{ inputs.sonar_project_key }} \
            -Dsonar.organization=${{ inputs.sonar_organization }} \
            -Dsonar.host.url=${{ inputs.sonar_host_url }} \
            -Dsonar.login=${{ inputs.sonar_token }}

      - name: Fetch Sonar coverage
        if: inputs.sonar_token != ''
        id: sonar_coverage
        run: |
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ inputs.sonar_token }}" \
            "${{ inputs.sonar_host_url }}/api/measures/component?component=${{ inputs.sonar_project_key }}&metricKeys=coverage")

          COVERAGE=$(echo "$RESPONSE" | jq -r '.component.measures[0].value')

          echo "SonarQube Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Publish Sonar coverage to PR
        if: github.event_name == 'pull_request' && inputs.sonar_token != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“Š **SonarQube Coverage:** ${{ steps.sonar_coverage.outputs.coverage }}%`
            })

      - name: Build application
        run: ${{ inputs.build_command }}

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push Docker image
        run: |
          docker build \
            --build-arg JAR_PATH=${{ inputs.jar_path }} \
            -f ${{ inputs.dockerfile_path }} \
            -t ${{ inputs.image_name }}:${{ inputs.image_tag }} .
          docker push ${{ inputs.image_name }}:${{ inputs.image_tag }}