name: Reusable Docker CI Pipeline

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      jar_path:
        required: true
        type: string
      build_command:
        required: true
        type: string
      dockerfile_path:
        required: false
        default: Dockerfile
        type: string

      # Sonar
      sonar_project_key:
        required: false
        type: string
      sonar_host_url:
        required: false
        type: string
      sonar_organization:
        required: false
        type: string
      sonar_token:
        required: false
        type: string

      # Snyk
      snyk_token:
        required: false
        type: string

      # JFrog
      jfrog_url:
        required: false
        type: string
      jfrog_docker_repo:
        required: false
        type: string

      JFROG_USERNAME:
        required: false
        type: string

      JFROG_API_KEY:
        required: false
        type: string

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - run: chmod +x mvnw

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

      # ✅ Checkstyle
      - name: Run Checkstyle
        run: ./mvnw checkstyle:check

      # ✅ Tests + Coverage
      - name: Run tests & calculate coverage
        id: local_coverage
        run: |
          ./mvnw clean test jacoco:report
          XML="target/site/jacoco/jacoco.xml"
          COVERED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'covered="\K[0-9]+' | awk '{s+=$1} END {print s}')
          MISSED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'missed="\K[0-9]+' | awk '{s+=$1} END {print s}')
          TOTAL=$((COVERED + MISSED))
          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED/$TOTAL)*100}")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      # ✅ Sonar
      - name: Sonar Scan
        if: inputs.sonar_token != ''
        env:
          SONAR_TOKEN: ${{ inputs.sonar_token }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=${{ inputs.sonar_project_key }} \
            -Dsonar.organization=${{ inputs.sonar_organization }} \
            -Dsonar.host.url=${{ inputs.sonar_host_url }}

      # ✅ Snyk dependency scan
      - name: Snyk Dependency Scan
        if: inputs.snyk_token != ''
        uses: snyk/actions/maven@v2
        env:
          SNYK_TOKEN: ${{ inputs.snyk_token }}

      # Build app
      - run: ${{ inputs.build_command }}

      # ✅ JFrog Docker login
      - name: Login to JFrog
        if: inputs.JFROG_API_KEY != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.jfrog_url }}
          username: ${{ inputs.JFROG_USERNAME }}
          password: ${{ inputs.JFROG_API_KEY }}

      # Build & push
      - name: Build & push image
        run: |
          IMAGE=${{ inputs.jfrog_url }}/${{ inputs.jfrog_docker_repo }}/${{ inputs.image_name }}:${{ inputs.image_tag }}
          docker build -t $IMAGE .
          docker push $IMAGE
