name: Reusable Docker CI Pipeline

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      jar_path:
        required: true
        type: string
      build_command:
        required: true
        type: string
      dockerfile_path:
        required: false
        default: Dockerfile
        type: string

      # ---------- Sonar ----------
      sonar_project_key:
        required: false
        type: string
      sonar_host_url:
        required: false
        type: string
      sonar_organization:
        required: false
        type: string
      sonar_token:
        required: false
        type: string

      SNYK_TOKEN:
        required: false
        type: string
      JFROG_URL:
        required: false
        type: string

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      JFROG_USER:
        required: false
      JFROG_PASSWORD:
        required: false

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-${{ runner.os }}-

      # ================= CHECKSTYLE =================
      
      - name: Run Checkstyle (Linting)
        id: checkstyle
        run: |
          ./mvnw checkstyle:checkstyle \
            -Dcheckstyle.config.location=google_checks.xml

          ERRORS=$(grep '<error ' target/site/checkstyle/checkstyle.xml | wc -l || true)
          echo "Checkstyle Errors: $ERRORS"
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

      - name: Upload Checkstyle report
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml

      - name: Publish Checkstyle result to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üßπ **Checkstyle Errors:** ${{ steps.checkstyle.outputs.errors }}`
            })

      # ================= TEST + LOCAL COVERAGE =================
      - name: Run tests & calculate local coverage
        id: local_coverage
        run: |
          ./mvnw clean test jacoco:report

          XML="target/site/jacoco/jacoco.xml"
          COVERED=$(grep 'counter type="INSTRUCTION"' $XML | grep -oP 'covered="\K[0-9]+' | awk '{s+=$1} END {print s}')
          MISSED=$(grep 'counter type="INSTRUCTION"' $XML | grep -oP 'missed="\K[0-9]+' | awk '{s+=$1} END {print s}')

          TOTAL=$((COVERED + MISSED))
          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED/$TOTAL)*100}")

          echo "Local Code Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

      - name: Publish local coverage to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Local Code Coverage:** ${{ steps.local_coverage.outputs.coverage }}%`
            })

      # ================= SONARQUBE =================
      - name: SonarQube Scan
        if: inputs.sonar_token != ''
        env:
          SONAR_TOKEN: ${{ inputs.sonar_token }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=${{ inputs.sonar_project_key }} \
            -Dsonar.organization=${{ inputs.sonar_organization }} \
            -Dsonar.host.url=${{ inputs.sonar_host_url }} \
            -Dsonar.login=${{ inputs.sonar_token }}

      - name: Fetch SonarQube coverage
        if: inputs.sonar_token != ''
        id: sonar_coverage
        run: |
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ inputs.sonar_token }}" \
            "${{ inputs.sonar_host_url }}/api/measures/component?component=${{ inputs.sonar_project_key }}&metricKeys=coverage")

          COVERAGE=$(echo "$RESPONSE" | jq -r '.component.measures[0].value')
          echo "SonarQube Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Publish Sonar coverage to PR
        if: github.event_name == 'pull_request' && inputs.sonar_token != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üìä **SonarQube Coverage:** ${{ steps.sonar_coverage.outputs.coverage }}%`
            })

      # ================= BUILD =================
      - name: Build application
        run: ${{ inputs.build_command }}

      # ================= SNYK =================
      - name: Install Snyk
        if: inputs.SNYK_TOKEN != ''
        run: npm install -g snyk

      - name: Run Snyk Scan
        if: inputs.SNYK_TOKEN != ''
        env:
          SNYK_TOKEN: ${{ inputs.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk test --all-projects --severity-threshold=high > snyk-result.txt || true

          # Count vulnerabilities
          HIGH=$(grep -c "High Severity Vulnerability" snyk-result.txt || true)
          CRITICAL=$(grep -c "Critical Severity Vulnerability" snyk-result.txt || true)

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT

      - name: Publish Snyk result to PR
        if: github.event_name == 'pull_request' && inputs.SNYK_TOKEN != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîê **Snyk Security Scan Result**
              
              - üî¥ Critical vulnerabilities: ${{ steps.snyk_scan.outputs.critical }}
              - üü† High vulnerabilities: ${{ steps.snyk_scan.outputs.high }}
              
              Please review before merging.`
            })

      # ================= JFROG =================
      - name: Configure Maven for JFrog
        if: inputs.JFROG_URL != ''
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>artifactory</id>
                <username>${{ secrets.JFROG_USER }}</username>
                <password>${{ secrets.JFROG_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Publish JAR to JFrog
        if: inputs.JFROG_URL != ''
        run: |
          ./mvnw deploy \
            -DskipTests \
            -DaltDeploymentRepository=artifactory::default::${{ inputs.JFROG_URL }}/libs-snapshot-local

      # ================= DOCKER =================
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        run: |
          docker build \
            --build-arg JAR_PATH=${{ inputs.jar_path }} \
            -f ${{ inputs.dockerfile_path }} \
            -t ${{ inputs.image_name }}:${{ inputs.image_tag }} .
          docker push ${{ inputs.image_name }}:${{ inputs.image_tag }}
