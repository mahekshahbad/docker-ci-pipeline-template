name: Reusable Docker CI Pipeline

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      jar_path:
        required: true
        type: string
      build_command:
        required: true
        type: string
      dockerfile_path:
        required: false
        default: Dockerfile
        type: string

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: false
      SONAR_HOST_URL:
        required: false
      SONAR_PROJECT_KEY:
        required: false

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      # -------------------------
      # PART A: Local Code Coverage
      # -------------------------
      - name: Run tests with JaCoCo
        id: coverage
        run: |
          ./mvnw clean test jacoco:report

          XML="target/site/jacoco/jacoco.xml"

          COVERED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'covered="\K[0-9]+' | awk '{sum+=$1} END {print sum}')
          MISSED=$(grep 'counter type="INSTRUCTION"' "$XML" | grep -oP 'missed="\K[0-9]+' | awk '{sum+=$1} END {print sum}')

          if [ -z "$COVERED" ] || [ -z "$MISSED" ]; then
            echo "Coverage data not found"
            exit 1
          fi

          COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED/($COVERED+$MISSED))*100}")

          echo "Local Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT


      - name: Comment local coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Local Code Coverage
          message: |
            ‚úÖ **JaCoCo Coverage**
            **${{ steps.coverage.outputs.coverage }}%**

      # -------------------------
      # PART B: SonarQube Analysis
      # -------------------------
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        if: env.SONAR_TOKEN != ''
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Install jq
        if: github.event_name == 'pull_request' && env.SONAR_TOKEN != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch SonarQube Coverage
        id: sonar
        if: github.event_name == 'pull_request' && env.SONAR_TOKEN != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          RESPONSE=$(curl -s -u $SONAR_TOKEN: \
            "${{ secrets.SONAR_HOST_URL }}/api/measures/component?component=${{ secrets.SONAR_PROJECT_KEY }}&metricKeys=coverage")

          SONAR_COVERAGE=$(echo "$RESPONSE" | jq -r '.component.measures[0].value')

          echo "sonar_coverage=$SONAR_COVERAGE" >> $GITHUB_OUTPUT

      - name: Comment SonarQube coverage on PR
        if: github.event_name == 'pull_request' && env.SONAR_TOKEN != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: SonarQube Coverage
          message: |
            üîç **SonarQube Coverage**
            **${{ steps.sonar.outputs.sonar_coverage }}%**

      # -------------------------
      # Build & Docker
      # -------------------------
      - name: Build application
        run: ${{ inputs.build_command }}

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push Docker image
        run: |
          docker build \
            --build-arg JAR_PATH=${{ inputs.jar_path }} \
            -f ${{ inputs.dockerfile_path }} \
            -t ${{ inputs.image_name }}:${{ inputs.image_tag }} .
          docker push ${{ inputs.image_name }}:${{ inputs.image_tag }}
